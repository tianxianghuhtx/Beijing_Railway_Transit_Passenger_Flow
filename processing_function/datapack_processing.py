from decimal import Decimal

line_priority = [
    "M1BATONG",
    "M2",
    "M3",
    "M4DAXING",
    "M5",
    "M6",
    "M7",
    "M8",
    "M9",
    "M10",
    "M11",
    "M12",
    "M13",
    "M14",
    "M15",
    "M16",
    "M17S",
    "M17N",
    "M17",
    "M19",
    "M24_YIZHUANG",
    "M25_FANGSHAN",
    "YANFANG",
    "M26_S1",
    "M27_CHANGPING",
    "M34_SHOUDUJICHANG",
    "M35_DAXINGJICHANG",
    "XIJIAO",
    "YIZHUANGT1"
]

flow_supplement = {
        "2023-12-18": 1091.01,
    "2023-12-19": 1085.73,
    "2023-12-20": 1086.38,
    "2023-12-21": 1082.89,
    "2023-12-22": 1176.29,
    "2023-12-23": 665.81,
    "2023-12-24": 628.81,
    "2023-12-25": 1113.72,
    "2023-12-26": 1101.29,
    "2023-12-27": 1106.74,
    "2023-12-28": 1113.64,
    "2023-12-29": 1203.27,
    "2023-12-30": 739.85,
    "2023-12-31": 756.70,
    "2024-01-01": 658.29,
    "2024-01-02": 1091.41,
    "2024-01-03": 1088.24,
    "2024-01-04": 1084.89,
    "2024-01-05": 1154.69,
    "2024-01-06": 646.72,
    "2024-01-07": 581.65,
    "2024-01-08": 1102.90,
    "2024-01-09": 1106.58,
    "2024-01-10": 1116.55,
    "2024-01-11": 1128.42,
    "2024-01-12": 1187.20,
    "2024-01-13": 703.74,
    "2024-01-14": 641.13,
    "2024-01-15": 1123.08,
    "2024-01-16": 1125.48,
    "2024-01-17": 1120.61,
    "2024-01-18": 1119.25,
    "2024-01-19": 1161.36,
    "2024-01-20": 712.43,
    "2024-01-21": 615.35,
    "2024-01-22": 1094.04,
    "2024-01-23": 1105.91,
    "2024-01-24": 1120.57,
    "2024-01-25": 1121.61,
    "2024-01-26": 1161.21,
    "2024-01-27": 735.85,
    "2024-01-28": 668.91,
    "2024-01-29": 1105.97,
    "2024-01-30": 1102.67,
    "2024-01-31": 1103.75,
    "2024-02-01": 1071.06,
    "2024-02-02": 1082.96,
    "2024-02-03": 635.94,
    "2024-02-04": 910.14,
    "2024-02-05": 919.20,
    "2024-02-06": 849.83,
    "2024-02-07": 715.88,
    "2024-02-08": 531.31,
    "2024-02-09": 273.66,
    "2024-02-10": 323.21,
    "2024-02-11": 422.71,
    "2024-02-12": 487.11,
    "2024-02-13": 537.55,
    "2024-02-14": 535.41,
    "2024-02-15": 541.82,
    "2024-02-16": 539.78,
    "2024-02-17": 548.18,
    "2024-02-18": 824.96,
    "2024-02-19": 960.20,
    "2024-02-20": 1034.71,
    "2024-02-21": 1122.10,
    "2024-02-22": 1067.18,
    "2024-02-23": 1124.78,
    "2024-02-24": 710.44,
    "2024-02-25": 648.09,
    "2024-02-26": 1089.69,
    "2024-02-27": 1091.89,
    "2024-02-28": 1101.89,
    "2024-02-29": 1105.74,
    "2024-03-01": 1194.39,
    "2024-03-02": 737.69,
    "2024-03-03": 660.10,
    "2024-03-04": 1094.89,
    "2024-03-05": 1080.05,
    "2024-03-06": 1104.85,
    "2024-03-07": 1096.76,
    "2024-03-08": 1244.99,
    "2024-03-09": 735.11,
    "2024-03-10": 661.95,
    "2024-03-11": 1088.32,
    "2024-03-12": 1092.71,
    "2024-03-13": 1098.03,
    "2024-03-14": 1092.69,
    "2024-03-15": 1190.24,
    "2024-03-16": 758.29,
    "2024-03-17": 697.63,
    "2024-03-18": 1100.71,
    "2024-03-19": 1099.83,
    "2024-03-20": 1123.14,
    "2024-03-21": 1103.43,
    "2024-03-22": 1207.24,
    "2024-03-23": 813.32,
    "2024-03-24": 664.59,
    "2024-03-25": 1109.14,
    "2024-03-26": 1114.73,
    "2024-03-27": 1106.19,
    "2024-03-28": 1111.32,
    "2024-03-29": 1219.89,
    "2024-03-30": 835.68,
    "2024-03-31": 742.39,
    "2024-04-01": 1113.92
}

from decimal import Decimal, ROUND_HALF_UP

def datapack_output_to_htxsheet(datapack, output_link):
    # 清空/创建输出文件
    open(output_link, "w", encoding="utf-8").close()      
    for png_date, ocrrespack in datapack:
        output_str = f"{png_date},{ocrrespack['date']},{ocrrespack['flow']},,"
        sum_val = Decimal("0.00")  # 使用Decimal初始化累加和
        for lp_element in line_priority:
            linedata = ocrrespack["linedata"]
            found = False
            for ld_element in linedata:
                if ld_element["name"] == lp_element:
                    output_str += ld_element["flow"]
                    found = True
                    # 累加每一行的flow，跳过错误或缺失值
                    if ld_element["flow"] not in ("ERROR", "NOVALUE"):
                        sum_val += Decimal(str(ld_element["flow"]))
                    break
            output_str += ","
        # 计算差值并判断误差
        if ocrrespack["flow"] not in ("ERROR", "NOVALUE"):
            # 用Decimal计算主flow与各行flow之差，并量化为两位小数
            sub = Decimal(str(ocrrespack["flow"])) - sum_val
            sub = sub.quantize(Decimal("0.00"), rounding=ROUND_HALF_UP)
            output_str += str(sub)
            # 根据差值大小添加误差标记
            if abs(sub) > Decimal("0.03"):
                output_str += ",TOO MUCH ERROR CORRECTION"
            elif abs(sub) != Decimal("0.00"):
                output_str += ",ERROR CORRECTION"
        else:
            if png_date in flow_supplement:
                sub = Decimal(flow_supplement[png_date]) - sum_val
                sub = sub.quantize(Decimal("0.00"), rounding=ROUND_HALF_UP)
                output_str += str(sub)
                if abs(sub) > Decimal("0.03"):
                    output_str += ",TOO MUCH ERROR CORRECTION"
                elif abs(sub) != Decimal("0.00"):
                    output_str += ",ERROR CORRECTION"
                output_str += ",USE SUPPLEMENT"
            else:
                output_str += "CAN NOT JUDGE"
        # 将结果行写入输出文件
        with open(output_link, "a", encoding="utf-8") as f:
            f.write(output_str + "\n")